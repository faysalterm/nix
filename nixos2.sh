#!/bin/bash

# ุชุญุฏูุฏ ุงููุฑุต ุงููุฏู
DISK="/dev/sda"

# ุงูุชุฃูุฏ ูู ุชุดุบูู ุงูุณูุฑูุจุช ุจุตูุงุญูุงุช root
if [[ $EUID -ne 0 ]]; then
    echo "๐จ ูุฌุจ ุชุดุบูู ูุฐุง ุงูุณูุฑูุจุช ุจุตูุงุญูุงุช root!"
    exit 1
fi

# ุงูุชุฃููุฏ ูุจู ุงููุชุงุจุนุฉ
echo "โ๏ธ ุณูุชู ุชูุณูู ุงููุฑุต $DISK ูุชุซุจูุช NixOS. ุชุฃูุฏ ูู ุฃุฎุฐ ูุณุฎุฉ ุงุญุชูุงุทูุฉ!"
read -p "โ ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ (yes/no): " confirm

if [[ "$confirm" != "yes" ]]; then
    echo "๐ซ ุชู ุงูุฅูุบุงุก."
    exit 1
fi

# ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุฑุต ููุฌูุฏูุง
if [[ ! -b "$DISK" ]]; then
    echo "โ ุงูุฎุทุฃ: ุงููุฑุต $DISK ุบูุฑ ููุฌูุฏ!"
    exit 1
fi

# 1๏ธโฃ ุฅูุดุงุก ุฌุฏูู ุชูุณูู ุฌุฏูุฏ (GPT)
echo "๐๏ธ ุฅูุดุงุก ุฌุฏูู ุชูุณูู GPT ุนูู $DISK..."
parted -s "$DISK" mklabel gpt || { echo "โ ูุดู ูู ุฅูุดุงุก ุฌุฏูู ุงูุชูุณูู!"; exit 1; }

# 2๏ธโฃ ุฅูุดุงุก ุงููุณู EFI
echo "๐ ุฅูุดุงุก ุงููุณู EFI..."
parted -s "$DISK" mkpart ESP fat32 1MiB 512MiB || { echo "โ ูุดู ูู ุฅูุดุงุก ุงููุณู EFI!"; exit 1; }
parted -s "$DISK" set 1 esp on

# 3๏ธโฃ ุฅูุดุงุก ุงููุณู ุงูุฌุฐุฑ (Root)
echo "๐ ุฅูุดุงุก ุงููุณู Root..."
parted -s "$DISK" mkpart primary ext4 512MiB 100% || { echo "โ ูุดู ูู ุฅูุดุงุก ุงููุณู Root!"; exit 1; }

# 4๏ธโฃ ุชููุฆุฉ ุงูุฃูุณุงู
echo "๐ง ุชููุฆุฉ ุงููุณู EFI..."
mkfs.fat -F 32 "${DISK}1" || { echo "โ ูุดู ูู ุชููุฆุฉ ุงููุณู EFI!"; exit 1; }

echo "๐ง ุชููุฆุฉ ุงููุณู Root..."
mkfs.ext4 -F "${DISK}2" || { echo "โ ูุดู ูู ุชููุฆุฉ ุงููุณู Root!"; exit 1; }

# 5๏ธโฃ ุชุญููู ุงูุฃูุณุงู
echo "๐ ุชุญููู ุงููุณู Root..."
mount "${DISK}2" /mnt || { echo "โ ูุดู ูู ุชุญููู ุงููุณู Root!"; exit 1; }

echo "๐ ุชุญููู ุงููุณู EFI..."
mkdir -p /mnt/boot
mount "${DISK}1" /mnt/boot || { echo "โ ูุดู ูู ุชุญููู ุงููุณู EFI!"; exit 1; }

# 6๏ธโฃ ุฅูุดุงุก ููู ุงูุชูููู
echo "โ๏ธ ุฅูุดุงุก ููู ุงูุชูููู configuration.nix..."
nixos-generate-config --root /mnt || { echo "โ ูุดู ูู ุฅูุดุงุก ููู ุงูุชูููู!"; exit 1; }

echo "โ ุชู ุงูุงูุชูุงุก ูู ุงูุชููุฆุฉ ุจูุฌุงุญ!"
echo "๐น ููููู ุงูุขู ุชุนุฏูู ููู ุงูุชูููู ุนุจุฑ: nano /mnt/etc/nixos/configuration.nix"
echo "๐น ุจุนุฏ ุงูุชุนุฏููุ ุซุจูุช ุงููุธุงู ุนุจุฑ: nixos-install"
